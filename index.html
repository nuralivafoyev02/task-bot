<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="app" class="p-4">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold">Vazifalar</h1>
            <select id="teamSelector" onchange="switchTeam()" class="bg-white border rounded px-2 py-1">
                </select>
        </header>

        <div id="taskList" class="space-y-3">
            </div>

        <button onclick="openCreateTask()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg">
            +
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const supabase = supabase.createClient('YOUR_URL', 'YOUR_KEY');
        let currentUserId = null;
        let selectedTeamId = null;

        async function init() {
            // Telegramdan kelgan user ma'lumotlarini tekshirish
            const user = tg.initDataUnsafe.user;
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('telegram_id', user.id)
                .single();
            
            currentUserId = profile.id;
            loadTeams();
        }

        async function loadTeams() {
            const { data: teams } = await supabase
                .from('team_members')
                .select('teams(*)')
                .eq('user_id', currentUserId);
            
            const selector = document.getElementById('teamSelector');
            teams.forEach(t => {
                selector.innerHTML += `<option value="${t.teams.id}">${t.teams.name}</option>`;
            });
            selectedTeamId = teams[0]?.teams.id;
            loadTasks();
        }

        async function loadTasks() {
            const { data: tasks } = await supabase
                .from('tasks')
                .select('*, profiles(full_name)')
                .eq('team_id', selectedTeamId);
            
            const list = document.getElementById('taskList');
            list.innerHTML = tasks.map(t => `
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="font-bold">${t.title}</h3>
                    <p class="text-sm text-gray-500">Kimga: ${t.profiles?.full_name || 'Hech kimga'}</p>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${t.status}</span>
                </div>
            `).join('');
        }

        function switchTeam() {
            selectedTeamId = document.getElementById('teamSelector').value;
            loadTasks();
        }

        init();
    </script>
</body>
</html>