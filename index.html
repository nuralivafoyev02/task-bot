<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Task Pro Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #f4f4f7);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #248bed);
            --tg-btn: var(--tg-theme-button-color, #248bed);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            -webkit-tap-highlight-color: transparent;
        }
        .task-card {
            background: var(--tg-secondary);
            backdrop-filter: blur(10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .task-card:active {
            transform: scale(0.97);
            opacity: 0.8;
        }
        .shimmer {
            background: linear-gradient(90deg, var(--tg-secondary) 25%, #e2e2e2 50%, var(--tg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .custom-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="custom-scroll overflow-y-auto">

    <div id="app" class="max-w-md mx-auto min-h-screen pb-24">
        
        <header class="sticky top-0 z-50 p-4 bg-opacity-80 backdrop-blur-md border-b border-gray-100 mb-4">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 class="text-2xl font-extrabold tracking-tight">Vazifalar</h1>
                    <p id="dateToday" class="text-xs text-gray-400"></p>
                </div>
                <div class="flex items-center space-x-2 bg-gray-100 rounded-full px-3 py-1 border border-gray-200">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <select id="teamSelector" onchange="handleTeamChange()" class="bg-transparent text-sm font-semibold outline-none border-none">
                        </select>
                </div>
            </div>
        </header>

        <div class="px-4 mb-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="p-4 rounded-3xl bg-blue-50 border border-blue-100 shadow-sm">
                    <span class="text-blue-600 font-bold text-2xl block" id="todoCount">0</span>
                    <span class="text-blue-800 text-xs font-medium opacity-70 italic">Jarayonda</span>
                </div>
                <div class="p-4 rounded-3xl bg-emerald-50 border border-emerald-100 shadow-sm">
                    <span class="text-emerald-600 font-bold text-2xl block" id="doneCount">0</span>
                    <span class="text-emerald-800 text-xs font-medium opacity-70 italic">Yakunlangan</span>
                </div>
            </div>
        </div>

        <div id="taskList" class="px-4 space-y-3">
            <div class="shimmer h-24 w-full rounded-2xl"></div>
            <div class="shimmer h-24 w-full rounded-2xl"></div>
        </div>

    </div>

    <button onclick="tg.MainButton.show()" id="fab" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center transform transition-transform active:scale-90 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <script>
        const tg = window.Telegram.WebApp;
        const supabaseUrl = 'https://trybbxovootehqvaiydn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyeWJieG92b290ZWhxdmFpeWRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2ODk1MTYsImV4cCI6MjA4MzI2NTUxNn0.szjMQBYb8_ZNMq8rZyowVPTgD2GYLNnWEvs7XlCHY1M';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUserId = null;
        let selectedTeamId = null;

        // Initialize App
        async function init() {
            tg.ready();
            tg.expand();
            tg.headerColor = 'var(--tg-theme-bg-color)';
            
            document.getElementById('dateToday').innerText = new Date().toLocaleDateString('uz-UZ', { weekday: 'long', day: 'numeric', month: 'long' });

            const user = tg.initDataUnsafe.user;
            if (!user) {
                document.body.innerHTML = "<p class='text-center mt-20'>Iltimos, bot orqali kiring!</p>";
                return;
            }

            // Fetch Profile
            const { data: profile } = await supabase.from('profiles').select('*').eq('telegram_id', user.id).single();
            if (profile) {
                currentUserId = profile.id;
                loadTeams(profile.current_team_id);
            }
        }

        // Load User's Teams
        async function loadTeams(defaultTeamId) {
            const { data: teamData } = await supabase.from('team_members').select('teams(*)').eq('user_id', currentUserId);
            const selector = document.getElementById('teamSelector');
            
            if (teamData && teamData.length > 0) {
                selector.innerHTML = teamData.map(t => `<option value="${t.teams.id}" ${t.teams.id === defaultTeamId ? 'selected' : ''}>${t.teams.name}</option>`).join('');
                selectedTeamId = defaultTeamId || teamData[0].teams.id;
                loadTasks();
            }
        }

        // Handle Team Switch
        async function handleTeamChange() {
            selectedTeamId = document.getElementById('teamSelector').value;
            tg.HapticFeedback.impactOccurred('medium');
            await supabase.from('profiles').update({ current_team_id: selectedTeamId }).eq('id', currentUserId);
            loadTasks();
        }

        // Load Tasks with slliiq UI
        async function loadTasks() {
            const listContainer = document.getElementById('taskList');
            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*, profiles!tasks_assigned_to_fkey(full_name)')
                .eq('team_id', selectedTeamId)
                .order('created_at', { ascending: false });

            if (tasks) {
                listContainer.innerHTML = tasks.map(task => `
                    <div onclick="toggleTaskStatus('${task.id}', '${task.status}')" class="task-card p-5 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between">
                        <div class="flex flex-col space-y-1">
                            <h3 class="text-sm font-bold ${task.status === 'done' ? 'line-through opacity-40' : ''}">${task.title}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="bg-gray-200 text-[10px] px-2 py-0.5 rounded-full font-medium opacity-70">@${task.profiles?.full_name || 'Hamma'}</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-2xl flex items-center justify-center ${task.status === 'done' ? 'bg-emerald-500 text-white' : 'bg-white border-2 border-gray-100'}">
                            ${task.status === 'done' ? 'âœ“' : ''}
                        </div>
                    </div>
                `).join('');

                // Update counts
                document.getElementById('todoCount').innerText = tasks.filter(t => t.status !== 'done').length;
                document.getElementById('doneCount').innerText = tasks.filter(t => t.status === 'done').length;
            }
        }

        // Toggle Status with Haptic Feedback
        async function toggleTaskStatus(taskId, currentStatus) {
            const newStatus = currentStatus === 'todo' ? 'done' : 'todo';
            tg.HapticFeedback.notificationOccurred(newStatus === 'done' ? 'success' : 'warning');
            
            const { error } = await supabase.from('tasks').update({ status: newStatus }).eq('id', taskId);
            if (!error) loadTasks();
        }

        init();
    </script>
</body>
</html>