<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Task Manager Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .card { background-color: var(--tg-theme-secondary-bg-color); }
        .btn-primary { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
    </style>
</head>
<body class="p-4 font-sans">
    <div id="app">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold">Mening Jamoam</h1>
            <select id="teamSelector" onchange="changeTeam()" class="card rounded-lg px-3 py-1 outline-none border-none">
                </select>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="card p-3 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <p class="text-xs opacity-60">Jarayonda</p>
                <h2 id="pendingCount" class="text-xl font-bold">0</h2>
            </div>
            <div class="card p-3 rounded-xl border-l-4 border-green-500 shadow-sm">
                <p class="text-xs opacity-60">Bajarildi</p>
                <h2 id="doneCount" class="text-xl font-bold">0</h2>
            </div>
        </div>

        <div id="taskList" class="space-y-3">
            <p class="text-center opacity-50 mt-10">Vazifalar yuklanmoqda...</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const supabase = supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_ANON_KEY');
        let currentUserId, selectedTeamId;

        async function init() {
            tg.ready();
            const { data: user } = await supabase.from('profiles').select('*').eq('telegram_id', tg.initDataUnsafe.user.id).single();
            currentUserId = user.id;
            
            // Jamoalarni yuklash
            const { data: teams } = await supabase.from('team_members').select('teams(*)').eq('user_id', currentUserId);
            const selector = document.getElementById('teamSelector');
            
            if (teams.length > 0) {
                selector.innerHTML = teams.map(t => `<option value="${t.teams.id}" ${user.current_team_id === t.teams.id ? 'selected' : ''}>${t.teams.name}</option>`).join('');
                selectedTeamId = user.current_team_id || teams[0].teams.id;
                loadTasks();
            } else {
                document.getElementById('taskList').innerHTML = "<p class='text-center'>Siz hali hech qaysi jamoaga a'zo emassiz.</p>";
            }
        }

        async function loadTasks() {
            const { data: tasks } = await supabase.from('tasks').select('*, assigned:profiles!tasks_assigned_to_fkey(full_name)').eq('team_id', selectedTeamId).order('created_at', { ascending: false });
            
            const list = document.getElementById('taskList');
            list.innerHTML = tasks.map(t => `
                <div class="card p-4 rounded-2xl shadow-sm transition-all active:scale-95" onclick="toggleStatus('${t.id}', '${t.status}')">
                    <div class="flex justify-between items-start">
                        <h3 class="${t.status === 'done' ? 'line-through opacity-50' : 'font-semibold text-lg'}">${t.title}</h3>
                        <span class="text-[10px] px-2 py-1 rounded-full ${t.status === 'done' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'} uppercase font-bold">
                            ${t.status}
                        </span>
                    </div>
                    <p class="text-sm opacity-60 mt-2">ðŸ‘¤ @${t.assigned?.full_name || 'Noma`lum'}</p>
                </div>
            `).join('');

            document.getElementById('pendingCount').innerText = tasks.filter(t => t.status !== 'done').length;
            document.getElementById('doneCount').innerText = tasks.filter(t => t.status === 'done').length;
        }

        async function changeTeam() {
            selectedTeamId = document.getElementById('teamSelector').value;
            await supabase.from('profiles').update({ current_team_id: selectedTeamId }).eq('id', currentUserId);
            loadTasks();
        }

        async function toggleStatus(taskId, currentStatus) {
            const newStatus = currentStatus === 'todo' ? 'done' : 'todo';
            tg.HapticFeedback.impactOccurred('medium');
            await supabase.from('tasks').update({ status: newStatus }).eq('id', taskId);
            loadTasks();
        }

        init();
    </script>
</body>
</html>