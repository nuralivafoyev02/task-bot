<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Task Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color, #ffffff); color: var(--tg-theme-text-color, #000000); }
        .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="p-4 font-sans">
    <div id="app" class="max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Vazifalar</h1>
            <select id="teamSelector" onchange="changeTeam()" class="bg-gray-100 p-1 rounded-lg text-sm font-semibold outline-none border-none">
                <option>Yuklanmoqda...</option>
            </select>
        </div>

        <div id="taskList" class="space-y-3">
            <div class="shimmer h-20 w-full rounded-2xl"></div>
            <div class="shimmer h-20 w-full rounded-2xl"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        // O'zgaruvchi nomini o'zgartirdik, to'qnashuv bo'lmasligi uchun
        const _supabase = supabase.createClient('https://trybbxovootehqvaiydn.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyeWJieG92b290ZWhxdmFpeWRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2ODk1MTYsImV4cCI6MjA4MzI2NTUxNn0.szjMQBYb8_ZNMq8rZyowVPTgD2GYLNnWEvs7XlCHY1M');

        let currentUserId;
        let selectedTeamId;

        async function init() {
            tg.ready();
            tg.expand();

            try {
                const tgUser = tg.initDataUnsafe.user;
                if (!tgUser) {
                    document.getElementById('taskList').innerHTML = "Iltimos, Telegram orqali kiring.";
                    return;
                }

                // 1. Profilni olish
                const { data: profile, error: pError } = await _supabase
                    .from('profiles')
                    .select('*')
                    .eq('telegram_id', tgUser.id)
                    .single();

                if (pError || !profile) throw new Error("Profil topilmadi. Botga /start bosing.");

                currentUserId = profile.id;
                
                // 2. Jamoalarni yuklash
                const { data: teams } = await _supabase
                    .from('team_members')
                    .select('teams(*)')
                    .eq('user_id', currentUserId);

                const selector = document.getElementById('teamSelector');
                if (teams && teams.length > 0) {
                    selector.innerHTML = teams.map(t => `<option value="${t.teams.id}" ${profile.current_team_id === t.teams.id ? 'selected' : ''}>${t.teams.name}</option>`).join('');
                    selectedTeamId = profile.current_team_id || teams[0].teams.id;
                    loadTasks();
                } else {
                    selector.innerHTML = "<option>Jamoa yo'q</option>";
                    document.getElementById('taskList').innerHTML = "<p class='text-center text-gray-400'>Siz hali hech qanday jamoaga qo'shilmagansiz.</p>";
                }

            } catch (err) {
                console.error(err);
                document.getElementById('taskList').innerHTML = `<p class='text-red-500 text-center'>${err.message}</p>`;
            }
        }

        async function loadTasks() {
            const { data: tasks } = await _supabase
                .from('tasks')
                .select('*, profiles!tasks_assigned_to_fkey(full_name)')
                .eq('team_id', selectedTeamId)
                .order('created_at', { ascending: false });

            const list = document.getElementById('taskList');
            if (tasks && tasks.length > 0) {
                list.innerHTML = tasks.map(t => `
                    <div onclick="toggleStatus('${t.id}', '${t.status}')" class="bg-gray-50 p-4 rounded-2xl flex justify-between items-center border border-gray-100 active:scale-95 transition-transform">
                        <div>
                            <p class="font-bold ${t.status === 'done' ? 'line-through text-gray-400' : ''}">${t.title}</p>
                            <p class="text-[10px] text-gray-400 font-medium">ðŸ‘¤ ${t.profiles?.full_name || 'Noma\'lum'}</p>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 ${t.status === 'done' ? 'bg-blue-500 border-blue-500' : 'border-gray-300'} flex items-center justify-center text-white text-xs">
                            ${t.status === 'done' ? 'âœ“' : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = "<p class='text-center text-gray-400 mt-10 text-sm italic'>Vazifalar hozircha yo'q</p>";
            }
        }

        async function toggleStatus(id, current) {
            const next = current === 'todo' ? 'done' : 'todo';
            tg.HapticFeedback.impactOccurred('light');
            await _supabase.from('tasks').update({ status: next }).eq('id', id);
            loadTasks();
        }

        async function changeTeam() {
            selectedTeamId = document.getElementById('teamSelector').value;
            await _supabase.from('profiles').update({ current_team_id: selectedTeamId }).eq('id', currentUserId);
            loadTasks();
        }

        init();
    </script>
</body>
</html>